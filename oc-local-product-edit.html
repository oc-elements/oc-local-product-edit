<link rel="import" href="../polymer/polymer.html">
<link rel="import" href="../oc-product-api/oc-product-api.html">
<link rel="import" href="../oc-product-option-api/oc-product-option-api.html">
<link rel="import" href="../oc-local-product-extras-api/oc-local-product-extras-api.html">
<link rel="import" href="../oc-product-edit/oc-product-edit.html">

<link rel="import" href="../oc-local-product-extras-edit/oc-local-product-extras-edit.html">
<link rel="import" href="../oc-local-product-options-edit/oc-local-product-options-edit.html">

<!--
`oc-local-product-edit`
Element to edit local product details on the Ordercloud platform

@demo demo/index.html
-->

<dom-module id="oc-local-product-edit">
    <template>
        <style>
            :host {
                display: block;
            }
        </style>

        <oc-product-api id="prodApi"></oc-product-api>
        <oc-product-option-api id="optionsApi"></oc-product-option-api>
        <oc-local-product-extras-api id="extrasApi"></oc-local-product-extras-api>

        <oc-product-edit selected="{{selected}}">
            <oc-local-product-options-edit organisation-id="[[organisationId]]" product-id="[[productId]]"  loading={{loading}} id="options"></oc-local-product-options-edit>
            <oc-local-product-extras-edit id="extras"></oc-local-product-extras-edit>
        </oc-product-edit>
    </template>

    <script>
        Polymer({

            is: 'oc-local-product-edit',

            properties: {
                organisationId: Number,
                productId : Number,
                selected: {
                    type: String,
                    notify: true
                },
                loading: {
                    type: Boolean,
                    notify: true
                }
            },

            observers: [
                '_observeRoute(routeData)',
                '_loadProductProperties(organisationId, productId)'
            ],

            _loadProductProperties : function(organisationId, productId) {
                this.loading = true;

                var getSelectedOptions = this.$.options.getSelectedOptions(productId);
                var getSelectableOptions = this.$.options.getSelectableOptions(organisationId);
                var getSelectedExtras = this.$.extras.getSelectedExtras(productId);
                var getSelectableExtras = this.$.extras.getSelectableExtras(organisationId);

                Promise.all([getSelectedOptions, getSelectableOptions, getSelectedExtras, getSelectableExtras])
                        .then(function(request) {
//                  option sets
                            this.$.options.originalList = request[0].response.results.slice();
                            this.$.options.selectedList = request[0].response.results;
                            this.$.options.selectableList = this._filterList(request[0].response.results, request[1].response.results);

//                  extra sets
                            this.$.extras.originalList = request[2].response.results.slice();
                            this.$.extras.selectedList = request[2].response.results;
                            this.$.extras.selectableList = this._filterList(request[2].response.results, request[3].response.results);
                        }.bind(this))
                        .catch(this.fire.bind(this, 'extra-set-error', 'Failed to load extra sets'))
                        .finally(this.set.bind(this, 'loading', false));
            },

            _filterList : function(selectedArr, selectableArr) {

                return selectableArr.filter(function(obj){
                    var notSelected = true;
                    for(var i=0; i<selectedArr.length; i++){
                        if (obj.options.length <= 0 || obj.id === selectedArr[i].id) {
                            notSelected = false;
                        }
                    }

                    return notSelected;
                })
            }


        });
    </script>
</dom-module>
